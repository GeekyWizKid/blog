{{/*
  Comments partial with CN-friendly providers (Twikoo, Waline, Artalk).
  Configure in hugo.toml under [params.comments].
*/}}
{{- $p := site.Params -}}
{{- $provider := $p.comments.provider | default "twikoo" -}}

{{- if eq $provider "twikoo" -}}
  {{- $cfg := $p.comments.twikoo -}}
  {{- if or $cfg.envId $cfg.serverURL -}}
    <div id="tcomment"></div>
    <script src="https://cdn.staticfile.org/twikoo/1.6.44/twikoo.all.min.js"></script>
    <script>
      // Guard against multiple inits (some pages/components may render twice)
      if (!window.__TWIKOO_INIT__) {
        window.__TWIKOO_INIT__ = true
        const cfg = {
          el: '#tcomment',
          path: '{{ .RelPermalink }}'
        };
        {{- if $cfg.envId }} cfg.envId = '{{ $cfg.envId }}'; cfg.region = '{{ $cfg.region | default "ap-shanghai" }}'; {{ end -}}
        {{- if $cfg.serverURL }} cfg.serverURL = '{{ $cfg.serverURL }}'; {{ end -}}
        twikoo.init(cfg).catch((e) => {
          console.error('Twikoo init failed:', e)
        })
      }
    </script>
  {{- else -}}
    <div class="text-sm text-neutral-500">未配置 Twikoo。请在 hugo.toml 的 [params.comments.twikoo] 下设置 envId（云开发）或 serverURL（Vercel/自建）。</div>
  {{- end -}}

{{- else if eq $provider "waline" -}}
  {{- $cfg := $p.comments.waline -}}
  {{- if $cfg.serverURL -}}
    <div id="waline"></div>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v3/dist/waline.css">
    <script src="https://fastly.jsdelivr.net/npm/@waline/client@v3/dist/waline.js"></script>
    <script>
      Waline.init({
        el: '#waline',
        serverURL: '{{ $cfg.serverURL }}',
        lang: '{{ $cfg.lang | default "zh-CN" }}',
        path: '{{ .RelPermalink }}',
        comment: true,
        emoji: {{ $cfg.emoji | default "[]" }},
      })
    </script>
  {{- else -}}
    <div class="text-sm text-neutral-500">未配置 Waline serverURL。请在 hugo.toml 的 [params.comments.waline] 下设置 serverURL。</div>
  {{- end -}}

{{- else if eq $provider "artalk" -}}
  {{- $cfg := $p.comments.artalk -}}
  {{- if and $cfg.server $cfg.site -}}
    <link rel="stylesheet" href="https://cdn.staticfile.org/artalk/2.8.5/Artalk.css">
    <div id="Comments"></div>
    <script src="https://cdn.staticfile.org/artalk/2.8.5/Artalk.js"></script>
    <script>
      Artalk.init({
        el: '#Comments',
        server: '{{ $cfg.server }}',
        site: '{{ $cfg.site }}',
        pageKey: '{{ .RelPermalink }}',
        pageTitle: '{{ .Title }}'
      })
    </script>
  {{- else -}}
    <div class="text-sm text-neutral-500">未配置 Artalk server/site。请在 hugo.toml 的 [params.comments.artalk] 下设置。</div>
  {{- end -}}

{{- else if eq $provider "giscus" -}}
  {{- $cfg := $p.comments.giscus -}}
  {{- if and $cfg.repo $cfg.repoId $cfg.category $cfg.categoryId -}}
    <script src="https://giscus.app/client.js"
            data-repo="{{ $cfg.repo }}"
            data-repo-id="{{ $cfg.repoId }}"
            data-category="{{ $cfg.category }}"
            data-category-id="{{ $cfg.categoryId }}"
            data-mapping="{{ $cfg.mapping | default "pathname" }}"
            data-strict="{{ $cfg.strict | default "0" }}"
            data-reactions-enabled="{{ $cfg.reactionsEnabled | default "1" }}"
            data-emit-metadata="{{ $cfg.emitMetadata | default "0" }}"
            data-input-position="{{ $cfg.inputPosition | default "top" }}"
            data-theme="{{ $cfg.theme | default "light" }}"
            data-lang="{{ $cfg.lang | default "zh-CN" }}"
            crossorigin="anonymous"
            async>
    </script>
    <div class="giscus"></div>
  {{- else -}}
    <div class="text-sm text-neutral-500">未配置 Giscus。请在 hugo.toml 的 [params.comments.giscus] 下设置 repo / repoId / category / categoryId。可在 giscus.app 生成。</div>
  {{- end -}}

{{- else -}}
  <div class="text-sm text-neutral-500">未知的评论 provider：{{ $provider }}。支持 twikoo / waline / artalk。</div>
{{- end -}}
