{{/*
  Comments partial with CN-friendly providers (Twikoo, Waline, Artalk).
  Configure in hugo.toml under [params.comments].
*/}}
{{- $p := site.Params -}}
{{- $provider := $p.comments.provider | default "twikoo" -}}

{{- if eq $provider "twikoo" -}}
  {{- $cfg := $p.comments.twikoo -}}
  {{- if or $cfg.envId $cfg.serverURL -}}
    {{- /* Normalize Twikoo config: envId for both CloudBase and Vercel/self-host */ -}}
    {{- $tkEnvId := (or $cfg.envId $cfg.serverURL) -}}
    {{- $tkRegion := ($cfg.region | default "ap-shanghai") -}}
    {{- $useRegion := (and $cfg.envId (not (hasPrefix $cfg.envId "http"))) -}}
    <div id="tcomment"></div>
    <script>
      (function(){
        var CDN_PRIMARY = 'https://cdn.staticfile.org/twikoo/1.6.44/twikoo.all.min.js';
        var CDN_FALLBACK = 'https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.all.min.js';

        function loadScript(url, onload, onerror) {
          var s = document.createElement('script');
          s.src = url;
          s.async = true;
          s.crossOrigin = 'anonymous';
          s.onload = onload;
          s.onerror = onerror;
          (document.head || document.documentElement).appendChild(s);
        }

        function ensureTwikooReady(done) {
          if (window.twikoo) return done();
          var triedFallback = false;
          var timeout = setTimeout(function(){
            if (!window.twikoo && !triedFallback) {
              triedFallback = true;
              loadScript(CDN_FALLBACK, function(){ done(); }, function(){ console.error('Twikoo CDN fallback failed'); });
            }
          }, 4000);
          loadScript(CDN_PRIMARY, function(){ clearTimeout(timeout); done(); }, function(){
            clearTimeout(timeout);
            if (!triedFallback) {
              triedFallback = true;
              loadScript(CDN_FALLBACK, function(){ done(); }, function(){ console.error('Twikoo CDN fallback failed'); });
            }
          });
        }

        function initTwikoo(){
          if (window.__TWIKOO_INIT__) return; // 防止重复初始化
          window.__TWIKOO_INIT__ = true;
          var cfg = { el: '#tcomment', path: '{{ .RelPermalink }}' };
          cfg.envId = '{{ $tkEnvId }}';
          {{- if $useRegion }} cfg.region = '{{ $tkRegion }}'; {{- end -}}
          function start(){
            try {
              if (!window.twikoo) { console.warn('Twikoo not loaded yet'); return; }
              twikoo.init(cfg).catch(function(e){ console.error('Twikoo init failed:', e); });
            } catch (e) {
              console.error('Twikoo init exception:', e);
            }
          }
          if (window.twikoo) start(); else ensureTwikooReady(start);
        }

        function runWhenReady(fn){
          if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once: true });
          else fn();
        }

        // 根据配置选择初始化时机：lazyLoad=true 使用 IntersectionObserver 懒加载，否则文档就绪后立即初始化
        var lazy = {{ with $p.comments.lazyLoad }}{{ . }}{{ else }}false{{ end }};
        if (lazy && 'IntersectionObserver' in window) {
          var el = document.getElementById('tcomment');
          if (el) {
            var io = new IntersectionObserver(function(entries){
              for (var i=0;i<entries.length;i++){
                if (entries[i].isIntersecting){ io.disconnect(); initTwikoo(); break; }
              }
            }, { rootMargin: '0px 0px 200px 0px', threshold: 0.01 });
            io.observe(el);
          } else {
            runWhenReady(initTwikoo);
          }
        } else {
          // 保险：既注册 DOMContentLoaded，又立即尝试一次（通常此处 DOM 已包含 #tcomment）。
          runWhenReady(initTwikoo);
          try { initTwikoo(); } catch(e) { /* ignore */ }
        }
      })();
    </script>
  {{- else -}}
    <div class="text-sm text-neutral-500">未配置 Twikoo。请在 hugo.toml 的 [params.comments.twikoo] 下设置 envId（云开发）或 serverURL（Vercel/自建）。</div>
  {{- end -}}

{{- else if eq $provider "waline" -}}
  {{- $cfg := $p.comments.waline -}}
  {{- if $cfg.serverURL -}}
    <div id="waline"></div>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v3/dist/waline.css">
    <script src="https://fastly.jsdelivr.net/npm/@waline/client@v3/dist/waline.js"></script>
    <script>
      Waline.init({
        el: '#waline',
        serverURL: '{{ $cfg.serverURL }}',
        lang: '{{ $cfg.lang | default "zh-CN" }}',
        path: '{{ .RelPermalink }}',
        comment: true,
        emoji: {{ $cfg.emoji | default "[]" }},
      })
    </script>
  {{- else -}}
    <div class="text-sm text-neutral-500">未配置 Waline serverURL。请在 hugo.toml 的 [params.comments.waline] 下设置 serverURL。</div>
  {{- end -}}

{{- else if eq $provider "artalk" -}}
  {{- $cfg := $p.comments.artalk -}}
  {{- if and $cfg.server $cfg.site -}}
    <link rel="stylesheet" href="https://cdn.staticfile.org/artalk/2.8.5/Artalk.css">
    <div id="Comments"></div>
    <script src="https://cdn.staticfile.org/artalk/2.8.5/Artalk.js"></script>
    <script>
      Artalk.init({
        el: '#Comments',
        server: '{{ $cfg.server }}',
        site: '{{ $cfg.site }}',
        pageKey: '{{ .RelPermalink }}',
        pageTitle: '{{ .Title }}'
      })
    </script>
  {{- else -}}
    <div class="text-sm text-neutral-500">未配置 Artalk server/site。请在 hugo.toml 的 [params.comments.artalk] 下设置。</div>
  {{- end -}}

{{- else if eq $provider "giscus" -}}
  {{- $cfg := $p.comments.giscus -}}
  {{- if and $cfg.repo $cfg.repoId $cfg.category $cfg.categoryId -}}
    <script src="https://giscus.app/client.js"
            data-repo="{{ $cfg.repo }}"
            data-repo-id="{{ $cfg.repoId }}"
            data-category="{{ $cfg.category }}"
            data-category-id="{{ $cfg.categoryId }}"
            data-mapping="{{ $cfg.mapping | default "pathname" }}"
            data-strict="{{ $cfg.strict | default "0" }}"
            data-reactions-enabled="{{ $cfg.reactionsEnabled | default "1" }}"
            data-emit-metadata="{{ $cfg.emitMetadata | default "0" }}"
            data-input-position="{{ $cfg.inputPosition | default "top" }}"
            data-theme="{{ $cfg.theme | default "light" }}"
            data-lang="{{ $cfg.lang | default "zh-CN" }}"
            crossorigin="anonymous"
            async>
    </script>
    <div class="giscus"></div>
  {{- else -}}
    <div class="text-sm text-neutral-500">未配置 Giscus。请在 hugo.toml 的 [params.comments.giscus] 下设置 repo / repoId / category / categoryId。可在 giscus.app 生成。</div>
  {{- end -}}

{{- else -}}
  <div class="text-sm text-neutral-500">未知的评论 provider：{{ $provider }}。支持 twikoo / waline / artalk。</div>
{{- end -}}
