{{ define "RenderImageSimple" -}}
  <img class="my-0 rounded-md" loading="lazy" alt="{{ .alt }}" src="{{ .src }}">
{{- end }}

{{ define "RenderImageResponsive" -}}
  <img
    class="my-0 rounded-md"
    loading="lazy"
    decoding="async"
    fetchpriority="low"
    alt="{{ .alt }}"
    srcset="
      {{ (.resource.Resize "330x").RelPermalink }}  330w,
      {{ (.resource.Resize "660x").RelPermalink }}  660w,
      {{ (.resource.Resize "1280x").RelPermalink }} 1280w
    "
    data-zoom-src="{{ .resource.RelPermalink }}"
    src="{{ .resource.RelPermalink }}">
{{- end }}

{{ define "RenderImageCaption" -}}
  {{- with .caption }}
    <figcaption>{{ . | markdownify }}</figcaption>
  {{- end }}
{{- end }}

{{- $disableImageOptimizationMD := .Page.Site.Params.disableImageOptimizationMD | default false }}
{{- $urlStr := .Destination | safeURL -}}
{{- $url := urls.Parse $urlStr -}}
{{- $altText := .Text }}
{{- $caption := .Title }}
{{- $isRemote := findRE "^(https?|data)" $url.Scheme }}
{{- $resource := "" }}
{{- $normalizedPath := "" }}
{{- $finalSrc := $urlStr }}

{{- if not $isRemote }}
  {{- $rawPath := $url.Path | default $urlStr }}
  {{- $normalizedPath = replaceRE "^\\./+" "" $rawPath }}
  {{- $normalizedPath = path.Clean $normalizedPath }}
  {{- if eq $normalizedPath "." }}
    {{- $normalizedPath = "" }}
  {{- end }}
  {{- if and $normalizedPath (not (strings.HasPrefix $normalizedPath "/")) }}
    {{- $resource = or ($.Page.Resources.GetMatch $normalizedPath) ($.Page.Resources.GetMatch (printf "**/%s" (path.Base $normalizedPath))) }}
  {{- end }}
  {{- if $resource }}
    {{- $finalSrc = $resource.RelPermalink }}
  {{- else if and $normalizedPath (strings.HasPrefix $normalizedPath "/") }}
    {{- $finalSrc = $normalizedPath }}
  {{- else if $normalizedPath }}
    {{- $finalSrc = path.Join .Page.RelPermalink $normalizedPath }}
  {{- end }}
{{- end }}

<figure>
  {{- if and (not $isRemote) $resource }}
    {{- $isSVG := eq $resource.MediaType.SubType "svg" }}
    {{- $shouldOptimize := and (not $disableImageOptimizationMD) (not $isSVG) }}
    {{- if $shouldOptimize }}
      {{ template "RenderImageResponsive" (dict "resource" $resource "alt" $altText) }}
    {{- else }}
      {{ template "RenderImageSimple" (dict "src" $resource.RelPermalink "alt" $altText) }}
    {{- end }}
  {{- else }}
    {{ template "RenderImageSimple" (dict "src" $finalSrc "alt" $altText) }}
  {{- end }}

  {{ template "RenderImageCaption" (dict "caption" $caption) }}
</figure>
